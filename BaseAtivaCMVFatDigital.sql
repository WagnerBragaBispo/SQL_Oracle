--CALCULO DE BASE;--========================================================================================================================;--                Contagem por NTC;--========================================================================================================================;;--tempo 475,74 seconds;;;/*jan-19	 9.235.064 ;fev-19	 9.429.958 ;mar-19	 9.589.680 ;abr-19	 9.650.044 ;mai-19	 9.961.284 ;jun-19	 10.220.117 ;jul-19	 10.350.216 ;ago-19	 10.546.837 ;*/;;select max(CMV.DAT_MOVIMENTO) from OPS_ALTERYX.BI_FP_BASE_ASSINANTE_CMV CMV;;;--========================================================================================================================;--                Contagem por DW_NUM_CLIENTE;--========================================================================================================================;;select /*+PARALLEL (30)*/  ;;   CMV.DAT_MOVIMENTO;   ,FAT.FLG_FATURA_DIGITAL;   ,FAT.FLG_DEBITO_AUTOMATICO;   ,COUNT(DISTINCT(CMV.DW_NUM_CLIENTE)) AS QTDE_CLI;;FROM DWH.BI_DIM_CLIENTE CLI ;LEFT JOIN OPS_ALTERYX.BI_FP_BASE_ASSINANTE_CMV CMV;     ON CMV.DW_NUM_CLIENTE = CLI.DW_NUM_CLIENTE;      ;LEFT JOIN OPS_ALTERYX.BI_FP_FATURA_CMV FAT;     ON FAT.DW_NUM_CLIENTE = CMV.DW_NUM_CLIENTE;    AND FAT.DAT_MOVIMENTO =  CMV.DAT_MOVIMENTO;          ;     where CMV.COD_PLATAFORMA = 'AUTOC';       AND CMV.COD_STATUS = 'A'; ;GROUP BY CMV.DAT_MOVIMENTO;   ,FAT.FLG_FATURA_DIGITAL;   ,FAT.FLG_DEBITO_AUTOMATICO;;--tempo 2.503,597 seconds;;;--========================================================================================================================;--                TODAS AS MARCAS CMV + PS8 motivo de contato + Inadimplência + Taxa de Abertura + perfil digital + ;--;--                precisamos criar a migração;--========================================================================================================================;;--========================================================================================================================;--                TODAS AS MARCAS CMV;--========================================================================================================================;;select /*+PARALLEL (30)*/  ;;   CMV.DAT_MOVIMENTO;   ,CMV.COD_PLATAFORMA;   ,FAT.FLG_FATURA_DIGITAL;   ,FAT.FLG_DEBITO_AUTOMATICO;   ,COUNT(DISTINCT(CMV.DW_NUM_CLIENTE)) AS QTDE_CLI;;FROM DWH.BI_DIM_CLIENTE CLI ;LEFT JOIN OPS_ALTERYX.BI_FP_BASE_ASSINANTE_CMV CMV;     ON CMV.DW_NUM_CLIENTE = CLI.DW_NUM_CLIENTE;      ;LEFT JOIN OPS_ALTERYX.BI_FP_FATURA_CMV FAT;     ON FAT.DW_NUM_CLIENTE = CMV.DW_NUM_CLIENTE;    AND FAT.DAT_MOVIMENTO =  CMV.DAT_MOVIMENTO;          ;     where /*CMV.COD_PLATAFORMA = 'AUTOC';       AND */CMV.COD_STATUS = 'A';       AND CMV.CMV.DAT_MOVIMENTO = '01/08/2019'; ;GROUP BY CMV.DAT_MOVIMENTO;   ,CMV.COD_PLATAFORMA;   ,FAT.FLG_FATURA_DIGITAL;   ,FAT.FLG_DEBITO_AUTOMATICO;;;;;--========================================================================================================================;--                base ativa de clientes Claro Móvel (SOMENTE FD);--========================================================================================================================;;;select /*+PARALLEL (30)*/  ;   DW_UN_NEG    ;   ,CMV.DAT_MOVIMENTO;   ,CMV.COD_PLATAFORMA;   ,FAT.FLG_FATURA_DIGITAL;   ,FAT.FLG_DEBITO_AUTOMATICO;   ,COUNT(DISTINCT(CMV.DW_NUM_CLIENTE)) AS QTDE_CLI;;FROM DWH.BI_DIM_CLIENTE CLI ;LEFT JOIN OPS_ALTERYX.BI_FP_BASE_ASSINANTE_CMV CMV;     ON CMV.DW_NUM_CLIENTE = CLI.DW_NUM_CLIENTE;      ;LEFT JOIN OPS_ALTERYX.BI_FP_FATURA_CMV FAT;     ON FAT.DW_NUM_CLIENTE = CMV.DW_NUM_CLIENTE;    AND FAT.DAT_MOVIMENTO =  CMV.DAT_MOVIMENTO;          ;     where /*CMV.COD_PLATAFORMA = 'AUTOC';       AND */CMV.COD_STATUS = 'A';       AND CMV.CMV.DAT_MOVIMENTO = &DT_MOVIMENTO;       AND FAT.DAT_MOVIMENTO = &DT_MOVIMENTO;       AND FAT.FLG_FATURA_DIGITAL = 1              ---somente fatura digital;GROUP BY ;   DW_UN_NEG;   ,CMV.DAT_MOVIMENTO;   ,CMV.COD_PLATAFORMA;   ,FAT.FLG_FATURA_DIGITAL;   ,FAT.FLG_DEBITO_AUTOMATICO;;;;--========================================================================================================================;--                base ativa de clientes Claro Móvel (inadimplentes DE FATURA DIGITAL);--                     BI_FP_CLI_INADIMPLENTE_CMV;--========================================================================================================================;/*select * from ALL_TABLES where TABLE_NAME like '%BI_FP_CLI_INADIMPLENTE_CMV%';;SELECT * FROM OPS_ALTERYX.BI_AGG_CLIENTE_CMV;;SELECT unique inad.flg_inadimplente_mv FROM OPS_ALTERYX.BI_FP_CLI_INADIMPLENTE_CMV INAD ;;SELECT UNIQUE CAD.FLG_INADIMPLENTE FROM OPS_ALTERYX.BI_FP_CLIENTE_CADASTRO CAD;*/;;select /*+PARALLEL (30)*/  ;   DW_UN_NEG    ;   ,CMV.DAT_MOVIMENTO;   ,CMV.COD_PLATAFORMA;   ,FAT.FLG_FATURA_DIGITAL;   ---,INAD.num_cpf_cnpj;   ---,CLI.dsc_nome_cliente ;   ,COUNT(DISTINCT(CMV.DW_NUM_CLIENTE)) AS QTDE_CLI; ;FROM DWH.BI_DIM_CLIENTE CLI ;LEFT JOIN OPS_ALTERYX.BI_FP_BASE_ASSINANTE_CMV CMV;     ON CMV.DW_NUM_CLIENTE = CLI.DW_NUM_CLIENTE;      ;LEFT JOIN OPS_ALTERYX.BI_FP_FATURA_CMV FAT;     ON FAT.DW_NUM_CLIENTE = CMV.DW_NUM_CLIENTE;    AND FAT.DAT_MOVIMENTO =  CMV.DAT_MOVIMENTO;;LEFT JOIN OPS_ALTERYX.BI_FP_CLI_INADIMPLENTE_CMV INAD ;     ON INAD.num_cpf_cnpj = CLI.NUM_CPF;    AND INAD.DAT_MOVIMENTO =  FAT.DAT_MOVIMENTO;          ;     where /*CMV.COD_PLATAFORMA = 'AUTOC';       AND */CMV.COD_STATUS = 'A';       AND CMV.CMV.DAT_MOVIMENTO = &DT_MOVIMENTO;       AND FAT.DAT_MOVIMENTO = &DT_MOVIMENTO;       AND INAD.DAT_MOVIMENTO = &DT_MOVIMENTO;       AND INAD.FLG_INADIMPLENTE_MV = 1                                    --- 1 = SOMENTE INADIMPLENTE;       /*AND FAT.FLG_FATURA_DIGITAL = 1 */                                 ---somente fatura digital;GROUP BY ;   DW_UN_NEG;   ,CMV.DAT_MOVIMENTO;   ,CMV.COD_PLATAFORMA;   ,FAT.FLG_FATURA_DIGITAL;   ,FAT.FLG_DEBITO_AUTOMATICO;   ,INAD.FLG_INADIMPLENTE_MV;/*   ,INAD.num_cpf_cnpj;    ,CLI.dsc_nome_cliente */;;;;select * from OPS_ALTERYX.BI_FP_BASE_ASSINANTE_CMV CMV;;;--========================================================================================================================;--         Informações do IN - Agregadadas                 ;--                ;--========================================================================================================================;;select ;BASE.DATA_BASE;,SUM(BASE.TT_BAN) ;from U93073439.BASE_FATURA_DIGITAL_AGG_MOVEL BASE ;where BASE.COD_PLATAFORMA_AJUSTADO = 'AUTOC' AND BASE.DATA_BASE = 201907;GROUP BY BASE.DATA_BASE;;select ;      BASE.DATA_BASE ;      ,BASE.COD_PLATAFORMA_AJUSTADO;      ,SUM(BASE.TT_NTC) AS TT_NTC;      ,SUM(BASE.TT_BAN) AS TT_BAN;from U93073439.BASE_FATURA_DIGITAL_AGG_MOVEL BASE;GROUP BY ;      BASE.DATA_BASE ;     ,BASE.COD_PLATAFORMA_AJUSTADO;;;;SELECT ;      CH.DATA_BASE;       ,CH.PLATAFORMA;       ,CH.MOVIMENTO;       ,CH.IND_DEBITO_AUTOMATICO;       ,SUM(CH.TT_NTC) AS QTDE_NTC  ;FROM U93073439.CHURN_FATURA_DIGITAL_AGG_MOVEL CH;GROUP BY;      CH.DATA_BASE;       ,CH.PLATAFORMA;       ,CH.MOVIMENTO;       ,CH.IND_DEBITO_AUTOMATICO;;;SELECT * FROM;U93073439.CR_FATURA_DIGITAL_AGG_MOVEL;;;;U93073439.BASE_FATURA_DIGITAL_AGG_MOVEL;U93073439.CHURN_FATURA_DIGITAL_AGG_MOVEL;;U93073439.CR_FATURA_DIGITAL_AGG_MOVEL;;;U93073439.BASE_FATURA_DIGITAL_AGG_RES;U93073439.CHURN_FATURA_DIGITAL_AGG_RES;;U93073439.CR_FATURA_DIGITAL_AGG_NET;U93073439.CR_FATURA_DIGITAL_AGG_CTV;;;--========================================================================================================================;--         Acesso aos Minha utilizando a função "FULL OUTER JOIN";--                ;--========================================================================================================================WITH       ACESSOS_RESIDENCIAL AS                                                                                (SELECT         /*+PARALLEL (12)*/                                                         SK_DATA,                                                         COUNT(*) AS QTD_ACSS_TV                                                                                                        FROM INN.DW_IDM_LOG A                                                   WHERE SK_DATA >= TO_NUMBER(&DATA_INICIAL)                                                     AND SK_DATA <= TO_NUMBER(&DATA_FINAL)                                                     AND UPPER(CLIENT_ID) LIKE '%TV%'                                                     GROUP BY                                                     SK_DATA),                                                            ACESSOS_MOVEL AS                                         (SELECT /*+ PARALLEL (32)*/                                         TO_NUMBER(TO_CHAR(DAT_INICIO_ATENDIMENTO, 'RRRRMMDD')) SK_DATA,                                         COUNT(*) AS QTD_ACSS_CMV                                  FROM DWH.BI_FP_ASSINANTE_ATEND_FECHADO@BASECLARO A                                         WHERE DW_METODO_CONTATO IN (81, 411, 451,681,701,552)                                               AND DAT_INICIO_ATENDIMENTO BETWEEN TO_DATE(&DATA_INICIAL, 'RRRRMMDD') AND  TO_DATE(&DATA_FINAL, 'RRRRMMDD')                                             -- NOVO FILTRO  -- SOMENTE USUÁRIOS QUE AUTENTICARAM -- EX: MinhaClaroWebPF: Autenticação de usuário                                                AND UPPER(A.DSC_OBSERVACAO_ATENDIMENTO) LIKE '%MINHACLAROWEB%AUTENTICA%USU%'                                          GROUP BY                                              TO_NUMBER(TO_CHAR(DAT_INICIO_ATENDIMENTO, 'RRRRMMDD')))       ;;;SELECT ;        A.SK_DATA,;        A.QTD_ACSS_TV,;        B.QTD_ACSS_CMV;FROM ACESSOS_RESIDENCIAL A;FULL OUTER JOIN ACESSOS_MOVEL B;ON A.SK_DATA = B.SK_DATA;ORDER BY SK_DATA;